#!/bin/sh
# Pre-push hook: ensure Rust code is formatted, passes tests, and clippy

# Get the repo root (where .git is)
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Run checks in the loom directory
cd "$REPO_ROOT/loom" || exit 1

echo "Running pre-push checks..."

# Check formatting
if ! cargo fmt --check 2>/dev/null; then
    echo ""
    echo "ERROR: Rust code is not formatted correctly."
    echo "Run 'cargo fmt' in the loom/ directory to fix."
    echo ""
    exit 1
fi

# Check markdown formatting (tracked files only)
cd "$REPO_ROOT" || exit 1
MD_FILES=$(git ls-files '*.md')
if [ -n "$MD_FILES" ]; then
    if ! echo "$MD_FILES" | xargs bunx markdownlint-cli2 2>/dev/null; then
        echo ""
        echo "ERROR: Markdown files have linting issues."
        echo "Run 'bunx markdownlint-cli2 --fix <files>' to fix."
        echo ""
        exit 1
    fi
fi
cd "$REPO_ROOT/loom" || exit 1

# Run clippy with warnings as errors
if ! cargo clippy -- -D warnings 2>&1; then
    echo ""
    echo "ERROR: Clippy found issues."
    echo "Fix the warnings above before pushing."
    echo ""
    exit 1
fi

# Run tests
# Unset git env vars to prevent interference with test repo creation
if ! env -u GIT_INDEX_FILE -u GIT_DIR -u GIT_WORK_TREE cargo test 2>&1; then
    echo ""
    echo "ERROR: Tests failed."
    echo "Fix the failing tests before pushing."
    echo ""
    exit 1
fi

echo "All pre-push checks passed."
